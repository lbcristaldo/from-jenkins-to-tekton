apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: docker-build-push
spec:
  params:
    - name: image-name
      type: string
    - name: image-tag
      type: string
      default: "latest"
    - name: dockerfile
      type: string
      default: "Dockerfile"
  workspaces:
    - name: source
  steps:
    - name: build-and-push
      image: gcr.io/kaniko-project/executor:v1.9.0
      workingDir: $(workspaces.source.path)/source
      command:
        - /kaniko/executor
      args:
        - --dockerfile=$(params.dockerfile)
        - --context=$(workspaces.source.path)/source
        - --destination=$(params.image-name):$(params.image-tag)
      volumeMounts:
        - name: docker-config
          mountPath: /kaniko/.docker/
  volumes:
    - name: docker-config
      secret:
        secretName: dockerhub-credentials
        items:
          - key: .dockerconfigjson
            path: config.json
  results:
    - name: IMAGE_URL
      description: Full URL of the built image
  steps:
    - name: build-and-push
      image: gcr.io/kaniko-project/executor:v1.9.0
      workingDir: $(workspaces.source.path)/source
      command:
        - /kaniko/executor
      args:
        - --dockerfile=$(params.dockerfile)
        - --context=$(workspaces.source.path)/source
        - --destination=$(params.image-name):$(params.image-tag)
      onError: continue
      script: |
        /kaniko/executor \
          --dockerfile=$(params.dockerfile) \
          --context=$(workspaces.source.path)/source \
          --destination=$(params.image-name):$(params.image-tag)
        echo -n "$(params.image-name):$(params.image-tag)" > $(results.IMAGE_URL.path)
      volumeMounts:
        - name: docker-config
          mountPath: /kaniko/.docker/
